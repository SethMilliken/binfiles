#!/bin/bash
# A script to select a Synergy configuration. Will attempt to autodetect network if no argument is given.
CONFIG_NAME=$1
#DEBUG_COMMAND=echo
DEBUG_COMMAND=
PRESET_NETWORK_NAMES="Available Presets: work, home"
#DIRECTORY="/Library/PreferencePanes/SynergyKM.prefPane/Contents/Resources/Synergyd.app/Contents/Resources"
# TODO: Use `which synergyc` here.
DIRECTORY="/usr/local/bin"
LOGFILE="${HOME}/Desktop/synergy.log"
DESTINATION=""
DEBUG_MODE="NOTE"

function run {
    preconditions
    select_network ${CONFIG_NAME}
    exit 0
}

function autodetect {
    #for TARGET in seth-g4.local. laboratory.local.
    for TARGET in seth.local seth-pc.local laboratory.local
    do
        HOST=`scutil -r ${TARGET} | grep -q Directly && echo ${TARGET}`
        if [ -n "${HOST}" ]
        then
            break
        fi
    done
    echo ${HOST}
}

function select_network {
    case ${CONFIG_NAME} in
        "-ls")      echo ${PRESET_NETWORK_NAMES}
                    exit 0;
                    ;;
        "work")     DESTINATION="seth.local"
                    ;;
        "home")     DESTINATION="seth-pc.local"
                    ;;
        *)          #echo Autodetected: `autodetect`
                    DESTINATION=`autodetect`
                    ;;
    esac

    echo "Selecting $DESTINATION"
    case ${DESTINATION} in
        # TODO: make this conditional on hostname
        "seth.local")
            case ${SHORTHOST} in
                "SAMSARA")      COMMAND="${DIRECTORY}/synergyc -f --name samsara --debug ${DEBUG_MODE} ${DESTINATION}"
                                ;;
                "SETH")         COMMAND="${DIRECTORY}/synergys -f --config ${HOME}/bin/synergy.conf --name seth --debug ${DEBUG_MODE}"
                                ;;
            esac
                                ;;
        #"laboratory.local.")   COMMAND="${DIRECTORY}/synergys -f --config ${HOME}/bin/synergy.conf --name samsara --debug ${DEBUG_MODE}"
        "laboratory.local")     COMMAND="${DIRECTORY}/synergyc -f --name ${SHORTHOST} --debug ${DEBUG_MODE} ${DESTINATION}"
                                ;;
        "seth-pc.local")        COMMAND="${DIRECTORY}/synergyc -f --name ${SHORTHOST} --debug ${DEBUG_MODE} ${DESTINATION}"
                                ;;
    esac

    ${DEBUG_COMMAND} ${COMMAND} &> ${LOGFILE} &
    MESSAGE="${SHORTHOST} "@" ${DESTINATION}"
    echo "${MESSAGE}"
    /usr/local/bin/growlnotify -t synswitch -m "${MESSAGE}"
}

function preconditions {
    case "`uname`" in
        "Darwin")   ${DEBUG_COMMAND} killall -m synergy
                    sleep 1
                    ;;
        "OpenBSD")  ;;
                *)  echo "This command only works in Mac OS X with SynergyKM installed."
                    exit 1
                    ;;
    esac
}
run
